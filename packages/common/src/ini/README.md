# INI Engine

A robust INI parser and renderer designed for ARK Survival Ascended server configuration files. This engine preserves unknown keys, comments, and formatting while providing structured access to registry-known settings.

## Features

- **Comment Preservation**: Leading and trailing comments are preserved through parse/render cycles
- **Unknown Key Preservation**: Keys not in the registry are preserved as raw blocks
- **Deterministic Output**: Stable, predictable formatting for minimal diff churn
- **Section Support**: Full support for INI sections `[SectionName]`
- **Registry Integration**: Distinguishes between known (registry) and unknown keys

## Usage

### Basic Parsing

```typescript
import { parseIni, renderIni } from '@ark-asa/common';

const iniContent = `
[ServerSettings]
ServerName=My ARK Server
Port=7777
`;

const document = parseIni(iniContent);
console.log(document.entries); // Array of structured entries
console.log(document.rawBlocks); // Array of raw/unclassified blocks
```

### Parsing with Known Keys

```typescript
import { parseIni, createKeyIdentifier } from '@ark-asa/common';

const knownKeys = new Set([
  'ServerSettings.ServerName',
  'ServerSettings.Port',
]);

const document = parseIni(iniContent, knownKeys);

// Known keys will have isKnown: true
// Unknown keys will be preserved in rawBlocks
```

### Rendering

```typescript
import { renderIni } from '@ark-asa/common';

const rendered = renderIni(document);
// Produces deterministic INI output
```

### Round-Trip Example

```typescript
const original = `
; Comment at top
[ServerSettings]
ServerName=My Server ; Trailing comment
Port=7777
UnknownModSetting=value
`;

const document = parseIni(original);
const rendered = renderIni(document);

// rendered preserves comments and unknown keys
```

## Data Structures

### IniEntry

Represents a single key-value pair:

```typescript
interface IniEntry {
  section: string;              // Section name (empty for top-level)
  key: string;                  // Key name
  value: string;                // Value (as string)
  isKnown: boolean;             // Whether key is in registry
  leadingComments: string[];    // Comments before this entry
  trailingComment?: string;     // Comment on same line
}
```

### RawIniBlock

Represents unclassified/unknown content:

```typescript
interface RawIniBlock {
  section: string;              // Section name
  rawContent: string;          // Raw content including formatting
  lineNumber: number;          // Original line number (for ordering)
}
```

### IniDocument

Complete INI document:

```typescript
interface IniDocument {
  entries: IniEntry[];         // Registry-known entries
  rawBlocks: RawIniBlock[];    // Raw/unclassified blocks
  leadingComments: string[];   // Comments at file start
}
```

## Example INI Files

### Simple Configuration

**Input:**
```ini
[ServerSettings]
ServerName=My ARK Server
ServerPassword=
Port=7777
QueryPort=27015
```

**Parsed Structure:**
- 4 entries in `ServerSettings` section
- All entries have `isKnown: false` (no registry provided)
- No raw blocks (all keys parsed as entries)

### Configuration with Comments

**Input:**
```ini
; ARK Server Configuration
; Generated by ARK Server Manager

[ServerSettings]
; Server name
ServerName=My ARK Server ; Display name
Port=7777
```

**Parsed Structure:**
- Leading comments: `["; ARK Server Configuration", "; Generated by ARK Server Manager"]`
- Entry `ServerName` has:
  - `leadingComments: ["; Server name"]`
  - `trailingComment: "; Display name"`

### Configuration with Unknown Keys

**Input:**
```ini
[ServerSettings]
ServerName=My Server
UnknownModKey=value123
ServerPassword=secret
AnotherUnknown=test
```

**Parsed Structure (with known keys):**
- If `ServerName` and `ServerPassword` are known:
  - `entries`: `ServerName`, `ServerPassword` (with `isKnown: true`)
  - `rawBlocks`: Contains `UnknownModKey` and `AnotherUnknown` as raw content

### Real-World ARK Configuration

**Input:**
```ini
; ARK Survival Ascended Server Configuration
; Server: MyCluster-01

[ServerSettings]
ServerName=MyCluster-01
ServerPassword=
ServerAdminPassword=admin123
; Network
Port=7777
QueryPort=27015
MaxPlayers=70

[GameSettings]
DifficultyOffset=1.0
DayCycleSpeedScale=1.0
NightTimeSpeedScale=1.0

; Mod-specific settings (unknown to registry)
[ModSettings]
SomeModKey=value
AnotherModKey=123
```

**Output (after parse/render):**
- All sections preserved
- All keys preserved (known and unknown)
- Comments preserved
- Deterministic ordering (sections and keys sorted)

## Testing

Run tests:

```bash
cd packages/common
pnpm test
```

Run tests with coverage:

```bash
pnpm test:cov
```

### Test Coverage

- ✅ Round-trip stability (parse → render → parse produces same result)
- ✅ Comment preservation (leading and trailing)
- ✅ Unknown key preservation
- ✅ Section handling
- ✅ Deterministic ordering
- ✅ Mixed known/unknown keys

## Implementation Notes

### Parser Behavior

1. **Section Headers**: `[SectionName]` creates a new section context
2. **Comments**: Lines starting with `;` or `#` are treated as comments
3. **Key-Value Pairs**: Format `key=value` (whitespace around `=` is trimmed)
4. **Trailing Comments**: Comments after values on the same line are preserved
5. **Unknown Keys**: Keys not in the registry are stored in `rawBlocks`

### Renderer Behavior

1. **Section Ordering**: Empty section first, then alphabetical
2. **Key Ordering**: Within each section, keys are sorted alphabetically
3. **Raw Blocks**: Preserved in original order (by line number)
4. **Comments**: Leading and trailing comments are preserved
5. **Formatting**: Consistent spacing and line breaks

### Stability Guarantees

- Same input → same output (deterministic)
- Parse → render → parse produces equivalent structure
- Unknown keys are never dropped
- Comments are preserved through round-trips

## Future Enhancements

- Template variable substitution (`${INSTANCE_NAME}`, etc.)
- Merge strategies (defaults → profile → instance)
- Diff generation between INI documents
- Validation against registry schema
- Rollback support with revision tracking

